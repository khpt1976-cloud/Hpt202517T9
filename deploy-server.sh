#!/bin/bash

# SCRIPT DEPLOY BOTPRESS V12 + NEXT.JS LÃŠN MÃY CHá»¦
# Sá»­ dá»¥ng script nÃ y Ä‘á»ƒ deploy lÃªn mÃ¡y chá»§ cá»§a báº¡n

echo "ğŸš€ DEPLOY BOTPRESS V12 + NEXT.JS TO SERVER"
echo "=========================================="

# Kiá»ƒm tra tham sá»‘
if [ $# -eq 0 ]; then
    echo "âŒ Vui lÃ²ng cung cáº¥p domain cá»§a báº¡n!"
    echo "CÃ¡ch sá»­ dá»¥ng: ./deploy-server.sh your-domain.com"
    echo "VÃ­ dá»¥: ./deploy-server.sh myserver.com"
    exit 1
fi

DOMAIN=$1
BOTPRESS_PORT=${2:-12000}
NEXTJS_PORT=${3:-12001}

echo "ğŸ“‹ ThÃ´ng tin deploy:"
echo "   Domain: $DOMAIN"
echo "   Botpress Port: $BOTPRESS_PORT"
echo "   Next.js Port: $NEXTJS_PORT"
echo ""

# Táº¡o file .env.local cho production
echo "ğŸ“ Táº¡o file .env.local cho production..."
cat > .env.local << EOF
# Botpress V12 Configuration for Production
NEXT_PUBLIC_BOTPRESS_URL=https://$DOMAIN:$BOTPRESS_PORT
NEXT_PUBLIC_NEXTJS_URL=https://$DOMAIN:$NEXTJS_PORT

# Generated by deploy script
DEPLOY_DOMAIN=$DOMAIN
DEPLOY_DATE=$(date)
EOF

echo "âœ… File .env.local Ä‘Ã£ Ä‘Æ°á»£c táº¡o"

# Kiá»ƒm tra Docker
echo "ğŸ³ Kiá»ƒm tra Docker..."
if ! command -v docker &> /dev/null; then
    echo "âŒ Docker chÆ°a Ä‘Æ°á»£c cÃ i Ä‘áº·t!"
    echo "Vui lÃ²ng cÃ i Docker trÆ°á»›c: https://docs.docker.com/get-docker/"
    exit 1
fi

# Khá»Ÿi Ä‘á»™ng Docker daemon náº¿u cáº§n
if ! docker info &> /dev/null; then
    echo "ğŸ”„ Khá»Ÿi Ä‘á»™ng Docker daemon..."
    sudo systemctl start docker
    sleep 5
fi

# Stop vÃ  remove container cÅ© náº¿u cÃ³
echo "ğŸ§¹ Dá»n dáº¹p container cÅ©..."
docker stop botpress-v12-production 2>/dev/null || true
docker rm botpress-v12-production 2>/dev/null || true

# Cháº¡y Botpress V12 container
echo "ğŸš€ Khá»Ÿi Ä‘á»™ng Botpress V12 container..."
docker run -d \
  --name botpress-v12-production \
  --restart unless-stopped \
  -p $BOTPRESS_PORT:3000 \
  -e EXTERNAL_URL=https://$DOMAIN:$BOTPRESS_PORT \
  -e BP_HOST=0.0.0.0 \
  -e BP_PORT=3000 \
  botpress/server:latest

# Kiá»ƒm tra container
sleep 10
if docker ps | grep -q botpress-v12-production; then
    echo "âœ… Botpress V12 container Ä‘ang cháº¡y"
else
    echo "âŒ Lá»—i khá»Ÿi Ä‘á»™ng Botpress V12 container"
    docker logs botpress-v12-production
    exit 1
fi

# CÃ i Ä‘áº·t dependencies
echo "ğŸ“¦ CÃ i Ä‘áº·t dependencies..."
npm install

# Build Next.js
echo "ğŸ”¨ Build Next.js..."
npm run build

# Khá»Ÿi Ä‘á»™ng Next.js
echo "ğŸš€ Khá»Ÿi Ä‘á»™ng Next.js..."
npm run start -- -p $NEXTJS_PORT -H 0.0.0.0 &
NEXTJS_PID=$!

# Chá» Next.js khá»Ÿi Ä‘á»™ng
sleep 15

# Kiá»ƒm tra services
echo "ğŸ” Kiá»ƒm tra services..."
echo "Botpress V12: https://$DOMAIN:$BOTPRESS_PORT"
echo "Next.js: https://$DOMAIN:$NEXTJS_PORT"

# Test local connections
if curl -f -s http://localhost:$BOTPRESS_PORT > /dev/null; then
    echo "âœ… Botpress V12 Ä‘ang cháº¡y local"
else
    echo "âŒ Botpress V12 khÃ´ng pháº£n há»“i"
fi

if curl -f -s http://localhost:$NEXTJS_PORT > /dev/null; then
    echo "âœ… Next.js Ä‘ang cháº¡y local"
else
    echo "âŒ Next.js khÃ´ng pháº£n há»“i"
fi

echo ""
echo "ğŸ‰ DEPLOY HOÃ€N THÃ€NH!"
echo "========================"
echo "ğŸŒ Truy cáº­p á»©ng dá»¥ng táº¡i: https://$DOMAIN:$NEXTJS_PORT"
echo "ğŸ¤– Botpress V12 Admin: https://$DOMAIN:$BOTPRESS_PORT/admin"
echo ""
echo "ğŸ“‹ Luá»“ng sá»­ dá»¥ng:"
echo "1. VÃ o: https://$DOMAIN:$NEXTJS_PORT"
echo "2. ÄÄƒng nháº­p"
echo "3. Admin â†’ AdminBot"
echo "4. Sá»­ dá»¥ng Botpress V12!"
echo ""
echo "ğŸ”§ Äá»ƒ dá»«ng services:"
echo "   docker stop botpress-v12-production"
echo "   kill $NEXTJS_PID"
echo ""
echo "ğŸ“ Log files:"
echo "   Botpress: docker logs botpress-v12-production"
echo "   Next.js PID: $NEXTJS_PID"